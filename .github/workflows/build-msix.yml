name: Build MSIX Package

on:
  push:
    branches: [ master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-2022
    
    strategy:
      fail-fast: false
      matrix:
        platform: [x86, x64]
        configuration: [Release]

    env:
      Solution_Name: Fort.ind UWP.sln
      Project_Path: Fort.ind UWP\Fort.ind UWP.vbproj
      Manifest_Path: Fort.ind UWP\Package.appxmanifest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Setup Visual Studio shell
      uses: egor-tensin/vs-shell@v2
      with:
        arch: x64

    - name: Restore NuGet packages
      run: nuget restore "${{ env.Solution_Name }}"

    - name: Update manifest version
      run: |
        if ("${{ github.ref }}" -match "refs/tags/v(.+)") {
          $version = $matches[1]
          $parts = $version.Split('.')
          while ($parts.Count -lt 4) { $parts += "0" }
          $version = $parts[0..3] -join '.'
        } else {
          $version = "1.0.${{ github.run_number }}.0"
        }
        Write-Host "Setting version to: $version"
        $manifestPath = "${{ env.Manifest_Path }}"
        [xml]$manifest = Get-Content $manifestPath
        $manifest.Package.Identity.Version = $version
        $manifest.Save($manifestPath)
        echo "APP_VERSION=$version" >> $env:GITHUB_ENV

    - name: Decode signing certificate
      if: github.event_name != 'pull_request'
      env:
        SIGNING_CERT: ${{ secrets.SIGNING_CERTIFICATE }}
        CERT_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
      run: |
        if ([string]::IsNullOrEmpty($env:SIGNING_CERT)) {
          Write-Host "No signing certificate found, will build unsigned"
          echo "HAS_CERTIFICATE=false" >> $env:GITHUB_ENV
        } else {
          $pfxPath = "Fort.ind UWP\Fort.ind UWP_TemporaryKey.pfx"
          $certBytes = [Convert]::FromBase64String($env:SIGNING_CERT)
          [IO.File]::WriteAllBytes($pfxPath, $certBytes)
          $pfxFullPath = (Resolve-Path $pfxPath).Path
          $securePassword = ConvertTo-SecureString -String $env:CERT_PASSWORD -Force -AsPlainText
          $cert = Get-PfxCertificate -FilePath $pfxFullPath -Password $securePassword
          $cerPath = "Fort.ind UWP\Fort.ind_UWP.cer"
          Export-Certificate -Cert $cert -FilePath $cerPath -Type CERT | Out-Null
          Write-Host "Exported public certificate to: $cerPath"
          echo "PFX_PATH=$pfxPath" >> $env:GITHUB_ENV
          echo "CER_PATH=$cerPath" >> $env:GITHUB_ENV
          echo "HAS_CERTIFICATE=true" >> $env:GITHUB_ENV
        }

    - name: Build MSIX Package (Signed)
      if: github.event_name != 'pull_request' && env.HAS_CERTIFICATE == 'true'
      env:
        CERT_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
      run: |
        msbuild "${{ env.Project_Path }}" `
          /p:Configuration=${{ matrix.configuration }} `
          /p:Platform=${{ matrix.platform }} `
          /p:UapAppxPackageBuildMode=SideloadOnly `
          /p:AppxBundle=Never `
          /p:AppxPackageSigningEnabled=true `
          /p:PackageCertificateKeyFile="Fort.ind UWP_TemporaryKey.pfx" `
          /p:PackageCertificatePassword="$env:CERT_PASSWORD" `
          /p:GenerateAppxPackageOnBuild=true `
          /restore

    - name: Build MSIX Package (Unsigned)
      if: github.event_name == 'pull_request' || env.HAS_CERTIFICATE != 'true'
      run: |
        msbuild "${{ env.Project_Path }}" `
          /p:Configuration=${{ matrix.configuration }} `
          /p:Platform=${{ matrix.platform }} `
          /p:UapAppxPackageBuildMode=SideloadOnly `
          /p:AppxBundle=Never `
          /p:AppxPackageSigningEnabled=false `
          /p:GenerateAppxPackageOnBuild=true `
          /restore

    - name: Copy Install Script and Certificate to Package
      shell: pwsh
      run: |
        $packageDir = Get-ChildItem -Path "Fort.ind UWP\AppPackages" -Directory | Select-Object -First 1
        if ($packageDir) {
          # Copy the installer script
          Copy-Item "scripts\Install.ps1" -Destination "$($packageDir.FullName)\Install.ps1"
          Write-Host "Copied Install.ps1 to package directory"
          
          # Copy certificate if it exists
          if (Test-Path "Fort.ind UWP\Fort.ind_UWP.cer") {
            Copy-Item "Fort.ind UWP\Fort.ind_UWP.cer" -Destination "$($packageDir.FullName)\Fort.ind_UWP.cer"
            Write-Host "Copied certificate to package directory"
          }
        }

    - name: Upload MSIX Package
      uses: actions/upload-artifact@v4
      with:
        name: MSIX-${{ matrix.platform }}-${{ matrix.configuration }}-v${{ env.APP_VERSION }}
        path: |
          Fort.ind UWP\AppPackages\**\*.msix
          Fort.ind UWP\AppPackages\**\*.appx
          Fort.ind UWP\AppPackages\**\*.cer
          Fort.ind UWP\AppPackages\**\Install.ps1
        if-no-files-found: warn

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: artifacts/**/*
        generate_release_notes: true
        draft: false
        prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
