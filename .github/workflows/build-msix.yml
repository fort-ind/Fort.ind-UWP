name: Build MSIX Package

on:
  push:
    branches: [ master ]
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  pull_request:
    branches: [ master ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  build:
    runs-on: windows-2022
    
    strategy:
      fail-fast: false  # Don't cancel other builds if one fails
      matrix:
        platform: [x86, x64]
        configuration: [Release]

    env:
      Solution_Name: Fort.ind UWP.sln
      Project_Path: Fort.ind UWP\Fort.ind UWP.vbproj
      Manifest_Path: Fort.ind UWP\Package.appxmanifest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Setup Visual Studio shell
      uses: egor-tensin/vs-shell@v2
      with:
        arch: x64

    - name: Restore NuGet packages
      run: nuget restore "${{ env.Solution_Name }}"

    # Version bumping - extracts version from tag or generates from run number
    - name: Update manifest version
      run: |
        # Get version from tag or generate from run number
        if ("${{ github.ref }}" -match "refs/tags/v(.+)") {
          $version = $matches[1]
          # Ensure 4-part version (add .0 if needed)
          $parts = $version.Split('.')
          while ($parts.Count -lt 4) {
            $parts += "0"
          }
          $version = $parts[0..3] -join '.'
        } else {
          # Auto-generate version: 1.0.{run_number}.0
          $version = "1.0.${{ github.run_number }}.0"
        }
        
        Write-Host "Setting version to: $version"
        
        # Update Package.appxmanifest
        $manifestPath = "${{ env.Manifest_Path }}"
        [xml]$manifest = Get-Content $manifestPath
        $manifest.Package.Identity.Version = $version
        $manifest.Save($manifestPath)
        
        Write-Host "Updated manifest version to $version"
        echo "APP_VERSION=$version" >> $env:GITHUB_ENV

    # Decode and install certificate for signing
    - name: Decode signing certificate
      if: github.event_name != 'pull_request'
      env:
        SIGNING_CERT: ${{ secrets.SIGNING_CERTIFICATE }}
      run: |
        if ([string]::IsNullOrEmpty($env:SIGNING_CERT)) {
          Write-Host "No signing certificate found, will build unsigned"
          echo "HAS_CERTIFICATE=false" >> $env:GITHUB_ENV
        } else {
          # Save certificate to the project folder, replacing the temporary key
          $pfxPath = "Fort.ind UWP\Fort.ind UWP_TemporaryKey.pfx"
          $certBytes = [Convert]::FromBase64String($env:SIGNING_CERT)
          [IO.File]::WriteAllBytes($pfxPath, $certBytes)
          echo "PFX_PATH=$pfxPath" >> $env:GITHUB_ENV
          echo "HAS_CERTIFICATE=true" >> $env:GITHUB_ENV
          Write-Host "Certificate decoded successfully to: $pfxPath"
        }

    - name: Build MSIX Package (Signed)
      if: github.event_name != 'pull_request' && env.HAS_CERTIFICATE == 'true'
      env:
        CERT_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
      run: |
        msbuild "${{ env.Project_Path }}" `
          /p:Configuration=${{ matrix.configuration }} `
          /p:Platform=${{ matrix.platform }} `
          /p:UapAppxPackageBuildMode=SideloadOnly `
          /p:AppxBundle=Never `
          /p:AppxPackageSigningEnabled=true `
          /p:PackageCertificateKeyFile="Fort.ind UWP_TemporaryKey.pfx" `
          /p:PackageCertificatePassword="$env:CERT_PASSWORD" `
          /p:GenerateAppxPackageOnBuild=true `
          /restore

    - name: Build MSIX Package (Unsigned)
      if: github.event_name == 'pull_request' || env.HAS_CERTIFICATE != 'true'
      run: |
        msbuild "${{ env.Project_Path }}" `
          /p:Configuration=${{ matrix.configuration }} `
          /p:Platform=${{ matrix.platform }} `
          /p:UapAppxPackageBuildMode=SideloadOnly `
          /p:AppxBundle=Never `
          /p:AppxPackageSigningEnabled=false `
          /p:GenerateAppxPackageOnBuild=true `
          /restore

    # Clean up certificate (restore original if needed)
    - name: Remove signing certificate
      if: always()
      run: |
        # Restore original git state for the certificate file
        git checkout -- "Fort.ind UWP\Fort.ind UWP_TemporaryKey.pfx" 2>$null
        Write-Host "Certificate file restored"

    - name: Upload MSIX Package
      uses: actions/upload-artifact@v4
      with:
        name: MSIX-${{ matrix.platform }}-${{ matrix.configuration }}-v${{ env.APP_VERSION }}
        path: |
          Fort.ind UWP\AppPackages\**\*.msix
          Fort.ind UWP\AppPackages\**\*.appx
        if-no-files-found: warn

  # Create GitHub Release when a version tag is pushed
  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: windows-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: artifacts/**/*
        generate_release_notes: true
        draft: false
        prerelease: ${{ contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
